name: 构建并发布插件

on:
  push:
    tags:
      - 'v*' # 仅在推送 v* 格式的 Git 标签时触发
  workflow_dispatch: # 允许手动触发

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须授予写权限才能创建和修改 Release

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install

      - name: 构建并打包插件
        run: pnpm zip

      # 调试步骤：列出 .output 目录下的所有文件
      # 这能帮助我们确认 zip 文件是否已正确生成
      - name: 查看构建产物
        run: ls -R .output

      # 创建或更新 GitHub Release
      - name: 发布到 Releases
        uses: softprops/action-gh-release@v2
        with:
          # `body_path` 可以指向一个文件，用于填充 Release 的描述信息
          # `generate_release_notes: true` 会自动生成发布日志
          generate_release_notes: true
          # `overwrite: true` 允许覆盖已存在的同名 Release
          # `fail_on_unmatched_files: true` 如果找不到文件则报错
          # `files` 字段使用通配符来匹配所有生成的 zip 和 xpi 文件
          files: |
            ./.output/*.zip
            ./.output/*.xpi
